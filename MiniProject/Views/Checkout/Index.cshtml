@{
    ViewData["Title"] = "Checkout";
    var amountRM = ViewBag.Amount / 0.24;
}

<script src="https://www.paypal.com/sdk/js?client-id=@(ViewBag.PaypalClientId)&currency=USD"></script>

<div class="checkout-wrapper" style="width:420px;">
    <h2 class="text-center mb-5">Complete your order</h2>
    <div class="checkout-wrapper">
        <label class="form-label">Total Amount (RM)</label>
        <b>@amountRM</b>
        <input class="form-control" type="hidden" id="totalAmount" value="@ViewBag.Amount" />
        <input class="form-control" type="hidden" id="reservationId" value="@ViewBag.rsId" />

    </div>

    <div id="notification-container" class="mt-3"></div>
    <div id="paypal-button-container" class="mt-3"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("PayPal client id:", "@ViewBag.PaypalClientId");
    if (!window.paypal) {
        console.error("PayPal SDK not loaded.");
        document.getElementById('notification-container').innerHTML =
            `<div class="alert alert-danger">PayPal SDK failed to load. Check client-id and network.</div>`;
        return;
    }

    paypal.Buttons({
        fundingSource: paypal.FUNDING.PAYPAL,
        style:{
                    layout:"vertical",
                    color:"blue",
                    shape:"rect",
                    label:"paypal"
        },
        async createOrder() {
            // send amount to server to create order
            const response = await fetch('@Url.Action("CreateOrder","Checkout")', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    amount: document.getElementById("totalAmount").value,
                    reservationId: document.getElementById("reservationId").value
                })
            });

            const order = await response.json();
            // use the property name your server returns (e.g. { id: "..."} )
            return order.id || order.Id || '';
        },

        async onApprove(data) {
            const response = await fetch('@Url.Action("CompleteOrder", "Checkout")', {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orderID: data.orderID })
            });

            const details = await response.json();

            if (details && details.status === "success") { // Here To implement the Payment index Post method
                    alert(`Your Payment is Successfully !!!`);
                    // Create a Form To pass token id
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '@Url.Action("ProcessingPayment","Checkout",new{id = ViewBag.rsId})';

                    if(details.paypalTokenId){
                        const tokenInput = document.createElement('input');
                        tokenInput.type = 'hidden';
                        tokenInput.name = 'PaypalCaptureId';
                        tokenInput.value = details.paypalTokenId;
                        form.appendChild(tokenInput);
                    }

                    const idInput = document.createElement('input');
                    idInput.type = 'hidden';
                    idInput.name = 'Id';
                    idInput.value = '@ViewBag.rsId';
                    form.appendChild(idInput);

                    document.body.appendChild(form);
                    form.submit();
                        
            } else {
                    alert(`Failed to complete the order!`);
                    window.location.assign("/Checkout/History");
            }
        },

        onCancel() {
                alert(`Your Payment have been cancelled,Please Check Your History to Pay the Outstanding Bill`);
                window.location.assign("/Checkout/History");

        },

        onError(err) {
            console.error("PayPal error:", err);
            document.getElementById("notification-container").innerHTML = `
                <div class='alert alert-danger alert-dismissible fade show' role='alert'>
                    <strong>An error occurred. Please try again later.</strong>
                    <button type='button' class='btn-close' data-bs-dismiss='alert' aria-label='Close'></button>
                </div>`;
        }

    }).render('#paypal-button-container');
});
</script>
