@using System.Text.Json
@model ReportPageVM
@{
    ViewBag.Title = "HomePage";
    Layout = "_Layout";


}

<style>
    .charts-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-top: 30px;
    }

    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-title {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.1rem;
    }
</style>

<div class="container my-4">

<!-- Customer Page -->
@if (!User.IsInRole("Admin"))
{
    <!-- Hero Section -->
    <div class="hero-section w3-animate-top">
        <h1>Welcome to Moonlight Loft</h1>
        <p>Your perfect getaway in the heart of Kuala Lumpur</p>
    </div>

    <!-- Info Cards Section -->
    <div class="info-cards">
        <!-- Map Card -->
        <div class="info-card">
                <div class="info-card-title">
                <span>📍</span> Our Location
            </div>
            <div class="map-container">
                <iframe src="https://www.google.com/maps?q=KualaLumpur,Malaysia&output=embed"
                        style="border:0;"
                        allowfullscreen
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </div>

        <!-- Review Card -->
        @if (ViewBag.Review != null)
        {
            var r = ViewBag.Review;
            <div class="info-card">
                <div class="info-card-title">
                    <span>⭐</span> Guest Review
                </div>
                <a href="/Review/HotelReview?hotelId=@r.HotelId" class="review-card">
                    <div class="review-header">
                        <span class="review-author">@r.MemberEmail</span>
                        <span class="badge bg-primary">View All</span>
                    </div>
                    <p class="review-comment">"@r.Comment"</p>
                    <div class="review-ratings">
                        <div class="rating-item">
                            <span class="rating-label">Service</span>
                            <span class="rating-value">@r.ServiceRating★</span>
                        </div>
                        <div class="rating-item">
                            <span class="rating-label">Cleanliness</span>
                            <span class="rating-value">@r.CleanlinessRating★</span>
                        </div>
                    </div>
                </a>
            </div>
        }
    </div>
        <!-- Available Rooms Section -->
        <h2 class="section-header">Available Rooms</h2>
        <div class="products">
            @foreach (var t in Model.RoomTypes)
            {
                var photo = t.RoomGalleries.Where(r => r.RoomTypeId == t.Id).Select(r => r.PhotoURL).FirstOrDefault();
                <div class="product">
                    <img data-get="Home/Detail?id=@t.Id" src="/room/@photo" alt="@t.Name">
                    <div class="product-info">
                        <span class="product-name">@t.Name</span>
                        <span class="product-price">RM @t.Price</span>
                    </div>
                </div>
            }
        </div>
}


    <!-- Admin Page -->
    @if (User.IsInRole("Admin"))
    {
        var roomTypeName = Model.SalesByRoomType.Select(s => s.RoomType).ToList();
        var salesForType = Model.SalesByRoomType.Select(s => s.TotalSales).ToList();

         var maxValue = salesForType.Max();
         var maxIndex = salesForType.IndexOf(maxValue);

         var minValue = salesForType.Min();
         var minIndex = salesForType.IndexOf(minValue);

         var totalSales = salesForType.Sum();

        <div class="container">
            <div class="row">
                <div class="col text-center bg-success text-light">
                    <h5>Highest Book Room Type</h5>
                    <p>@roomTypeName[maxIndex]</p>
                    <p>RM @maxValue</p>
                </div>
                <div class="col text-center bg-danger text-light">
                    <h5>Lowest Book Room Type</h5>
                    <p>@roomTypeName[minIndex]</p>
                    <p>RM @minValue</p>
                </div>
                <div class="col text-center bg-info text-light">
                    <h5>Total Sales</h5>
                    <p></p>
                    <p>RM @totalSales</p>
                </div>
            </div>
        </div>
        <div class="charts-row">
            <div class="chart-container">
                <h3 class="chart-title">Sales Analytics</h3>
                <canvas id="myChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Sales Distrubution</h3>
                <canvas id="myPie"></canvas>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        var labels = @Html.Raw(JsonSerializer.Serialize(Model.SalesByRoomType.Select(s => s.RoomType)));
        var values = @Html.Raw(JsonSerializer.Serialize(Model.SalesByRoomType.Select(s => s.TotalSales)));

        if (document.getElementById("myChart") && labels.length > 0) {
            new Chart("myChart", {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Sales (RM)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => 'RM ' + value
                            }
                        }
                    }
                }
            });
        }

            // Pie Chart
            if (document.getElementById("myPie") && labels.length > 0) {
                // Generate colors dynamically based on number of room types
                const colors = [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)',
                    'rgb(201, 203, 207)'
                ];

                new Chart("myPie", {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Sales (RM)',
                            data: values,
                            backgroundColor: colors.slice(0, labels.length),
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': RM ' + value.toLocaleString() + ' (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
    </script>
        }
</div>